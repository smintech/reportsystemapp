<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | Ratel</title>

<style>
    /* ====== VARIABLES ====== */
    :root {
        --font-primary: "Inter", Arial, sans-serif;

        --color-bg: #f1f5f9;
        --color-text: #1e293b;
        --color-header: #2563eb;
        --color-header-text: #ffffff;

        --color-card-bg: #ffffff;
        --color-row-alt: #e0f2fe;

        --color-btn-primary: #2563eb;
        --color-btn-primary-hover: #1d4ed8;

        --color-btn-logout: #334155;
        --color-btn-logout-hover: #0f172a;

        --color-btn-delete: #ef4444;
        --color-btn-delete-hover: #dc2626;

        --color-btn-toggle: #1d4ed8;
        --color-btn-toggle-hover: #1b40c4;

        --radius: 12px;
        --shadow: 0 8px 20px rgba(0,0,0,0.12);
        --transition: 0.3s ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: var(--font-primary);
    }

    body {
        background: var(--color-bg);
        color: var(--color-text);
    }

    .dashboard-header {
        background: var(--color-header);
        color: var(--color-header-text);
        padding: 23px 30px;
        font-size: 1.8rem;
        font-weight: 700;
        text-align: center;
        box-shadow: var(--shadow);
    }

    .btn {
        display: inline-block;
        padding: 10px 18px;
        border-radius: var(--radius);
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
        color: #fff;
        cursor: pointer;
    }

    .btn-primary { background: var(--color-btn-primary); }
    .btn-primary:hover { background: var(--color-btn-primary-hover); transform: scale(1.03); }

    .btn-logout { background: var(--color-btn-logout); }
    .btn-logout:hover { background: var(--color-btn-logout-hover); transform: scale(1.03); }

    .btn-delete {
        background: var(--color-btn-delete);
        border: none;
        padding: 6px 12px;
        font-size: 14px;
    }
    .btn-delete:hover { background: var(--color-btn-delete-hover); transform: scale(1.05); }

    .btn-toggle {
        background: var(--color-btn-toggle);
        border: none;
        padding: 6px 12px;
        font-size: 14px;
    }
    .btn-toggle:hover { background: var(--color-btn-toggle-hover); transform: scale(1.05); }

    .top-actions {
        padding: 20px 30px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .flash-messages {
        margin: 10px 30px;
        list-style: none;
    }
    .flash-messages li {
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: var(--radius);
        font-weight: 600;
    }
    .success { background: #dcfce7; color: #16a34a; }
    .error { background: #fee2e2; color: #dc2626; }

    .card {
        background: var(--color-card-bg);
        margin: 20px 30px;
        padding: 25px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }

    .card h2 {
        margin-bottom: 18px;
        font-size: 1.4rem;
        font-weight: 700;
    }

    .user-table,
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 15px;
        min-width: 700px;
    }

    .user-table th,
    .user-table td,
    .report-table th,
    .report-table td {
        padding: 14px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
    }

    .user-table th,
    .report-table th {
        background: var(--color-header);
        color: var(--color-header-text);
    }

    .user-table tr:nth-child(even) td,
    .report-table tr:nth-child(even) td {
        background: var(--color-row-alt);
    }

    .user-table tr:hover td,
    .report-table tr:hover td {
        background: #dbeafe;
        transition: var(--transition);
    }

    .details {
        display: none;
        margin-top: 6px;
        font-size: 0.9rem;
        padding: 8px 10px;
        background: #f1f5f9;
        border-radius: 8px;
    }

    /* ===== EVIDENCE BOX ===== */
    .evidence-box {
        margin-top: 20px;
        padding: 18px;
        background: #f0f9ff;
        border-left: 5px solid #2563eb;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }

    .evidence-box a {
        color: #1d4ed8;
        font-weight: 600;
        text-decoration: none;
    }
    .evidence-box a:hover {
        text-decoration: underline;
    }

</style>
</head>
<body>

<div class="dashboard-header">Admin Dashboard</div>

<div class="top-actions">
    <span class="btn btn-primary">Welcome, Moorelink!</span>
    <a href="{{ url_for('admin_logout') }}" class="btn btn-logout">Logout</a>
    <a href="{{ url_for('list_users') }}" class="btn btn-primary">View Users</a>
    <a href="{{ url_for('add_user') }}" class="btn btn-primary">Add New User</a>
    <a href="{{ url_for('reports_page') }}" class="btn btn-primary">Manage Reports</a>
    <a href="{{ url_for('reports_page') }}" class="btn btn-primary">View All Reports</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul class="flash-messages">
      {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<div class="card">
    <h2>Users Preview</h2>

    <div style="overflow-x:auto;">
        <table class="user-table">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.email }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.created_at }}</td>
                    <td>
                        <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn-delete"
                            onclick="return confirm('Delete user {{ user.email }}?');">
                                Delete
                            </button>
                        </form>

                        <button class="btn-toggle" onclick="toggleDetails({{ user.id }})">
                            Show Details
                        </button>

                        <div id="details-{{ user.id }}" class="details">
                            <strong>Password (hashed):</strong><br>
                            {{ user.password_hash }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>
</div>

<!-- REPORTS PREVIEW -->
<div class="card">
    <h2>Recent Reports</h2>

    <div style="overflow-x:auto;">
        <table class="report-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tracking ID</th>
                    <th>Category</th>
                    <th>Status</th>
                    <th>Reporter Email</th>
                    <th>Assigned To</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for r in reports[:10] %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>{{ r.tracking_id }}</td>
                    <td>{{ r.category }}</td>
                    <td>{{ r.status }}</td>
                    <td>{{ r.reporter_email if r.reporter_email else 'Anonymous' }}</td>
                    <td>{{ r.assigned_staff_id if r.assigned_staff_id else 'Unassigned' }}</td>
                    <td>{{ r.created_at }}</td>
                    <td>
                        <a href="{{ url_for('view_report', rid=r.id) }}" class="btn btn-primary" style="padding:6px 10px;font-size:13px;">
                            View
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>

    <!-- ===== EVIDENCE PREVIEW SECTION ===== -->
    <div class="evidence-box">
            {% for report in reports %}
                <h4>Uploaded Files:</h4>
                <ul>
                    {% if report.evidence_parsed.files %}
                        <li>
                            <a href="{{ url_for('get_evidence', tracking_id=r.tracking_id, filename=f) }}" target="_blank">
                                Download {{ f }}
                            </a>
                        </li>
                    {% endif %}
                </ul>

            {% elif evidence.single %}
                <h4>Uploaded File:</h4>
                <a href="{{ url_for('get_evidence', tracking_id=r.tracking_id, filename=evidence.single) }}" target="_blank">
                    Download {{ evidence.single }}
                </a>

            {% elif evidence.link %}
                <h4>Evidence Link:</h4>
                <a href="{{ evidence.link }}" target="_blank">
                    {{ evidence.link }}
                </a>

            {% else %}
                <p>No evidence submitted.</p>
            {% endfor %}
    </div>
</div>

<script>
    function toggleDetails(id) {
        const box = document.getElementById("details-" + id);
        box.style.display = box.style.display === "none" ? "block" : "none";
    }
</script>

</body>
</html>