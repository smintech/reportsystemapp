<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Dashboard</title>
<style>
    /* ===== VARIABLES ===== */
    :root {
        --nigeria-green: #006940;
        --nigeria-green-dark: #004d30;
        --nigeria-green-light: #008751;
        --white: #ffffff;
        --off-white: #f8f9fa;
        --light-gray: #e0e0e0;
        --text-dark: #1a1a1a;
        --text-gray: #333333;
        --accent-gold: #c9a227;
        --shadow: rgba(0, 105, 64, 0.15);
        --shadow-dark: rgba(0, 0, 0, 0.25);
        --radius: 12px;
        --padding: 20px;
        --font-primary: "Inter", Arial, sans-serif;
        --transition: 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-primary); }
    body { background: var(--off-white); color: var(--text-dark); overflow-x: hidden; }

    /* ===== HEADER ===== */
    .dashboard-header {
        width: 100vw;
        background: var(--nigeria-green);
        color: var(--white);
        padding: 30px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 10px var(--shadow-dark);
        min-height: 120px;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
    }

    .dashboard-header h2 { font-size: 1.8rem; font-weight: 700; }

    .btn-logout {
        padding: 12px 22px;
        background: var(--accent-gold);
        color: var(--white);
        text-decoration: none;
        border-radius: var(--radius);
        font-weight: 600;
    }
    .btn-logout:hover {
        background: #b5931f;
        transform: scale(1.05);
    }

    /* CONTENT */
    .dashboard-content { padding: 30px 40px; }

    .dashboard-content h2 {
        margin-top: 20px;
        margin-bottom: 15px;
        color: var(--nigeria-green-dark);
    }

    /* TABLE */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin-bottom: 25px;
        min-width: 700px;
        overflow-x: auto;
    }

    th, td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--light-gray);
        text-align: left;
    }

    th { background: var(--nigeria-green); color: var(--white); }
    tr:nth-child(even) td { background: var(--nigeria-green-light); color: var(--white); }
    tr:hover td { background: #00a14f; color: var(--white); }

    /* TABLE BUTTONS */
    .btn-table {
        padding: 6px 12px;
        border-radius: var(--radius);
        border: none;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        margin: 2px 0;
    }

    .btn-view { background: #2563eb; }
    .btn-view:hover { background: #1d4ed8; }

    .btn-assign { background: #10b981; }
    .btn-assign:hover { background: #059669; }

    .btn-status { background: #f59e0b; }
    .btn-status:hover { background: #b45309; }
    
    .btn-delete { background: red; }
    .btn-delete:hover { background: red; }

    select {
        padding: 5px 8px;
        border-radius: var(--radius);
        border: 1px solid #ccc;
        margin-right: 5px;
    }

    form { display: inline; }

    /* EVIDENCE BOX */
    .evidence-box {
        background: var(--white);
        padding: 20px;
        margin: 20px 0;
        border-left: 5px solid var(--nigeria-green);
        border-radius: var(--radius);
        box-shadow: 0 4px 10px var(--shadow);
    }

    .evidence-item a {
        color: #2563eb;
        text-decoration: none;
    }
    .evidence-item a:hover { text-decoration: underline; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="dashboard-header">
    <h2>Welcome, {{ staff_email }}</h2>
    <a href="{{ url_for('staff_logout') }}" class="btn-logout">Logout</a>
</div>

<!-- CONTENT -->
<div class="dashboard-content">
    <p>Role: {{ staff_role }}</p>

{% if staff_role == 'vdmratelking' %}

    <!-- USERS -->
    <h2>All Users</h2>
    <div style="overflow-x:auto;">
        <table>
            <thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Created</th></tr></thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.id }}</td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.role }}</td>
                    <td>{{ u.created_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- REPORTS -->
    <h2>All Reports</h2>
    <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>ID</th><th>Anonymous Sender ID</th><th>Tracking ID</th><th>Category Selected</th><th>Options Selected</th>
                    <th>Status</th><th>Assigned To</th><th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reports %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>{{ r.anon_id }}</td>
                    <td>{{ r.tracking_id }}</td>
                    <td>{{ r.category_group }}</td>
                    <td>{{ r.options_group }}</td>
                    <td>{{ r.status }}</td>
                    <td>{{ r.assigned_staff_id or 'Unassigned' }}</td>
                    <td>
                        <div class="evidence-box">
  {% if report.evidence_parsed.manual_link %}
    <p><strong>Provided Link:</strong>
        <a href="{{ report.evidence_parsed.manual_link }}" target="_blank">
            {{ report.evidence_parsed.manual_link }}
        </a>
    </p>
{% endif %}

{% if report.evidence_parsed.uploaded_files %}
    <p><strong>Uploaded Files ({{ report.evidence_parsed.uploaded_files|length }}):</strong></p>
    <ul>
        {% for file in report.evidence_parsed.uploaded_files %}
            <li>
                <a href="{{ file.url }}" target="_blank">
                    {% if file.filename.endswith(('.png', '.jpg', '.jpeg', '.gif', '.webp')) %}
                        <img src="{{ file.url }}" alt="{{ file.filename }}" style="max-width: 300px; margin: 10px 0;">
                    {% else %}
                        {{ file.filename }}
                    {% endif %}
                </a>
            </li>
        {% endfor %}
    </ul>
{% else %}
    <p>No uploaded files.</p>
{% endif %}
            </div>
                        <a href="{{ url_for('view_report', rid=r.id) }}" class="btn-table btn-view">View</a>

                        <form method="post" action="{{ url_for('assign_to_self_staff', rid=r.id) }}">
                            <button class="btn-table btn-assign">Assign To Me</button>
                        </form>

                        <form method="post" action="{{ url_for('assign_to_other_staff', rid=r.id) }}">
                            <select name="user_email">
                                {% for u in users %}
                                {% if u.role != 'admin' %}
                                <option value="{{ u.email }}">{{ u.email }} ({{ u.role }})</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <button class="btn-table btn-assign">Assign Other</button>
                        </form>
                        
                         <form action="/delete/{{ r.tracking_id }}" method="POST" style="display:inline;">
                            <button class="btn-table btn-delete" onclick="return confirm('Delete this report?');">Delete</button>
                        </form>

                        <form method="post" action="{{ url_for('change_status_staff', rid=r.id) }}">
                            <select name="status">
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Resolved">Resolved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Closed">Closed</option>
                            </select>
                            <button class="btn-table btn-status">Update</button>
                        </form>
                    </td>
                </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>

{% else %}

    <!-- STAFF PERSONAL REPORTS -->
    <h2>My Assigned Reports</h2>
    <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr><th>ID</th><th>Anonymous Sender ID</th><th>Tracking</th><th>Category Selected</th><th>Options Selected</th>
                    <th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody>
                {% for r in reports %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>{{ r.anon_id }}</td>
                    <td>{{ r.tracking_id }}</td>
                    <td>{{ r.category_group }}</td>
                    <td>{{ r.options_group }}</td>
                    <td>{{ r.status }}</td>
                    <td>
                        <a href="{{ url_for('view_report', rid=r.id) }}" class="btn-table btn-view">View</a>

                        <form method="post" action="{{ url_for('change_status_staff', rid=r.id) }}">
                            <select name="status">
                                <option value="Pending" {% if r.status=='Pending' %}selected{% endif %}>Pending</option>
                                <option value="In Progress" {% if r.status=='In Progress' %}selected{% endif %}>In Progress</option>
                                <option value="Resolved" {% if r.status=='Resolved' %}selected{% endif %}>Resolved</option>
                                <option value="Rejected" {% if r.status=='Rejected' %}selected{% endif %}>Rejected</option>
                                <option value="Closed" {% if r.status=='Closed' %}selected{% endif %}>Closed</option>
                            </select>
                            <button class="btn-table btn-status">Update</button>
                        </form>
                    </td>
                </tr>

                <!-- Staff evidence display -->
                <tr>
                    <td colspan="5">
                        <div class="evidence-box">
    <h4>Evidence</h4>

    {% set parsed = report.evidence_parsed if report.evidence_parsed is defined else parse_evidence(report.evidence) %}

    <!-- Manual Provided Link -->
    {% if parsed.manual_link %}
        <p><strong>Provided Link:</strong></p>
        <p>
            <a href="{{ parsed.manual_link }}" target="_blank" rel="noopener noreferrer">
                {{ parsed.manual_link }}
            </a>
        </p>
    {% endif %}

    <!-- Uploaded Files from Cloudinary -->
    {% if parsed.uploaded_files and parsed.uploaded_files|length > 0 %}
        <p><strong>Uploaded Files ({{ parsed.uploaded_files|length }}):</strong></p>
        <div class="uploaded-files-grid">
            {% for file in parsed.uploaded_files %}
                <div class="file-item" style="margin-bottom: 15px;">
                    <a href="{{ file.url }}" target="_blank" rel="noopener noreferrer">
                        {% if file.filename|lower|slice(-4) in ['.png', '.jpg', 'jpeg', '.gif', 'webp'] or file.filename|lower|slice(-5) in ['.jpeg', '.webp'] %}
                            <img src="{{ file.url }}" alt="{{ file.filename }}" style="max-width: 350px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <br><small>{{ file.filename }}</small>
                        {% else %}
                            <strong>ðŸ“Ž {{ file.filename }}</strong>
                        {% endif %}
                    </a>
                </div>
            {% endfor %}
        </div>
    {% elif parsed.manual_link is none and (parsed.uploaded_files is none or parsed.uploaded_files|length == 0) %}
        <p><em>No evidence provided.</em></p>
    {% endif %}
                        </div>
                    </td>
                </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>

{% endif %}
</div>

</body>
</html>